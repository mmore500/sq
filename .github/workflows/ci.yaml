name: HPCC Job Monitor

on:
  push:
    branches:
      - master
  schedule:
    - cron: "*/5 * * * *"  # every 5 minutes
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  fetch-jobs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Run job script on HPCC
        id: hpcc
        run: |
          set -e
          sshpass -p "${{ secrets.PASSWORD }}" ssh -o StrictHostKeyChecking=no "${{ secrets.USER }}@hpcc.msu.edu" 'bash -s' <<'EOF' | tee job_status.txt
          job_list=$(squeue --noheader -u "$USER" -o "%i|%j|%t|%M|%R")
          ...
          done <<< "$job_list"
          EOF

      - name: Parse quota usage and notify via Pushover
        env:
          PUSHOVER_TOKEN: ${{ secrets.PUSHOVER_APP_TOKEN }}
          PUSHOVER_USER: ${{ secrets.PUSHOVER_USER_KEY }}
        run: |
          set -euo pipefail
          python3 <<-'PY'
          	import re
          	rows = []
          	with open("job_status.txt", encoding="utf-8") as fh:
          	    in_quota = False
          	    for line in fh:
          	        if line.startswith("===== Quota Usage"):
          	            in_quota = True
          	            continue
          	        if not in_quota:
          	            continue
          	        if line.startswith("===== ") and "Detailed Job Table" in line:
          	            break
          	        if not line.startswith("|"):
          	            continue
          	        parts = [part.strip() for part in line.strip().split("|")[1:-1]]
          	        if len(parts) < 9:
          	            continue
          	        directory = parts[0]

          	        def extract_pct(value: str) -> float:
          	            match = re.search(r"([0-9]+(\.[0-9]+)?)%", value)
          	            return float(match.group(1)) if match else 0.0

          	        space_pct = extract_pct(parts[4])
          	        files_pct = extract_pct(parts[8])
          	        print(f"parsed {space_pct=} {files_pct=}")
          	        if directory and (space_pct >= 70 or files_pct >= 70):
          	            rows.append((directory, space_pct, files_pct))

          	if rows:
          	    lines = ["Quota usage warning:"]
          	    for directory, space_pct, files_pct in rows:
          	        lines.append(f"{directory}: space {space_pct:.1f}% | files {files_pct:.1f}%")
          	    with open("quota_alert.txt", "w") as f:
          	        print("\n".join(lines), file=f)
          	PY
          if [ -s quota_alert.txt ]; then
            message=$(cat quota_alert.txt)
            echo "Quota threshold exceeded. Sending Pushover notification."
            echo "${message}"
            curl -fsS \
              --form-string "token=${PUSHOVER_TOKEN}" \
              --form-string "user=${PUSHOVER_USER}" \
              --form-string "title=HPCC quota usage warning" \
              --form-string "message=${message}" \
              https://api.pushover.net/1/messages.json
          else
            echo "No quota metrics exceeded the threshold."
          fi

      - name: Generate webpage
        run: |
          set -euo pipefail
          mkdir -p public
          runtime_stats=$(python3 -c 'from textwrap import dedent; exec(dedent(""" 
            ... (rest unchanged) ...
          """))')
          echo "runtime_stats $runtime_stats"
          ...
          } > public/index.html

      - name: Create numbered page copies
        run: |
          for i in {0..999}; do
            cp public/index.html "public/${i}.html"
            cp public/index.html "public/$(printf '%03d' "$i").html"
          done

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: fetch-jobs
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
